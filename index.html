<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Garbicz Festival 2025 - Interactive Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root {
            --garbicz-pink: #ff00ff;
            --garbicz-yellow: #ffeb00;
            --garbicz-orange: #ff6e00;
            --garbicz-blue: #0019ff;
            --garbicz-green: #00f000;
            --garbicz-purple: #7d19ff;
            --garbicz-cyan: #00ffff;
            --garbicz-red: #ff0000;
            --garbicz-gray: #7d7d7d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            height: 100dvh;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--garbicz-yellow) 0%, var(--garbicz-orange) 25%, var(--garbicz-pink) 50%, var(--garbicz-blue) 75%, var(--garbicz-green) 100%);
            position: fixed;
            width: 100%;
            height: 100%;
            height: 100dvh;
            top: 0;
            left: 0;
        }
        
        .garbicz-map-container {
            height: 100vh;
            height: 100dvh;
            position: relative;
            width: 100%;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            position: relative;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            height: 60vh;
            height: 60dvh;
            order: 1;
            z-index: 1;
        }
        
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .audio-player {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 0, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: all 0.3s ease;
            transform: translateY(100px);
            opacity: 0;
            max-width: 320px;
            margin: 0 auto;
        }
        
        .audio-player.active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .audio-player.collapsed {
            transform: translateY(40px);
        }
        
        .audio-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(240, 240, 240, 0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border-radius: 12px 12px 0 0;
        }
        
        .audio-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--garbicz-purple);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .audio-controls {
            display: flex;
            gap: 6px;
        }
        
        .audio-btn {
            background: rgba(125, 25, 255, 0.1);
            border: 1px solid rgba(125, 25, 255, 0.2);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            padding: 6px;
            transition: all 0.2s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--garbicz-purple);
        }
        
        .audio-btn:hover, .audio-btn:active {
            background: var(--garbicz-purple);
            color: white;
            transform: translateY(-1px);
        }
        
        .audio-content {
            padding: 12px 16px;
            max-height: 180px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-radius: 0 0 12px 12px;
        }
        
        .audio-content.collapsed {
            max-height: 0;
            padding: 0 16px;
        }
        
        .soundcloud-widget {
            width: 100%;
            height: 120px;
            border: none;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .track-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }
        
        .track-btn {
            padding: 4px 10px;
            background: rgba(255, 0, 255, 0.1);
            color: var(--garbicz-purple);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .track-btn:hover, .track-btn:active {
            background: var(--garbicz-pink);
            color: white;
            border-color: var(--garbicz-pink);
            transform: translateY(-1px);
        }
        
        .track-btn.active {
            background: var(--garbicz-orange);
            color: white;
            border-color: var(--garbicz-orange);
        }
        
        .sidebar {
            background: white;
            border-top: 3px solid var(--garbicz-pink);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: all 0.3s ease;
            order: 2;
            height: 40vh;
            height: 40dvh;
            overflow: hidden;
            position: relative;
        }
        
        .sidebar.collapsed {
            height: 60px;
            overflow: hidden;
        }
        
        .sidebar-toggle {
            display: block;
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 50%;
            font-size: 18px;
            color: var(--garbicz-purple);
            cursor: pointer;
            z-index: 1001;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .sidebar-toggle:hover, .sidebar-toggle:active {
            background: var(--garbicz-purple);
            color: white;
        }
        
        .header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--garbicz-pink) 0%, var(--garbicz-purple) 50%, var(--garbicz-blue) 100%);
            color: white;
            position: relative;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.3);
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .header p {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .controls {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            flex-shrink: 0;
        }
        
        .festival-welcome {
            padding: 12px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--garbicz-pink);
            border-radius: 8px;
            color: var(--garbicz-purple);
            text-align: center;
            box-shadow: 0 2px 8px rgba(255, 0, 255, 0.1);
        }
        
        .welcome-title {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .welcome-subtitle {
            font-size: 10px;
            opacity: 0.9;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-label {
            font-size: 11px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .button-group {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .btn {
            flex: 1;
            min-width: 50px;
            padding: 8px 12px;
            border: 1px solid rgba(125, 25, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.8);
            color: var(--garbicz-purple);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        .btn:hover, .btn:active {
            background: rgba(125, 25, 255, 0.1);
            border-color: var(--garbicz-purple);
            transform: translateY(-1px);
        }
        
        .btn.active {
            background: var(--garbicz-purple);
            color: white;
            border-color: var(--garbicz-purple);
            box-shadow: 0 4px 12px rgba(125, 25, 255, 0.3);
        }
        
        .search-container {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            flex-shrink: 0;
        }
        
        .search-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .add-location {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            display: none;
            flex-shrink: 0;
        }
        
        .add-location.show {
            display: block;
        }
        
        .add-title {
            font-size: 12px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 10px;
        }
        
        .input-group {
            margin-bottom: 6px;
        }
        
        .input-label {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 3px;
            display: block;
        }
        
        .input-field {
            width: 100%;
            padding: 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .coord-inputs {
            display: flex;
            gap: 6px;
        }
        
        .coord-inputs .input-field {
            flex: 1;
        }
        
        .add-btn {
            width: 100%;
            padding: 10px;
            background: var(--garbicz-green);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .add-btn:hover, .add-btn:active {
            background: #00d000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 240, 0, 0.3);
        }
        
        .locations-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
        }
        
        .location-category {
            margin-bottom: 16px;
        }
        
        .category-title {
            font-size: 12px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 6px;
            padding: 6px 0;
            border-bottom: 2px solid #f1f3f4;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .category-toggle {
            font-size: 11px;
            color: #6c757d;
        }
        
        .category-items {
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        
        .category-items.collapsed {
            max-height: 0;
        }
        
        .location-item {
            display: flex;
            align-items: center;
            padding: 6px 4px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            margin: 2px 0;
            min-height: 44px;
        }
        
        .location-item:hover, .location-item:active {
            background: #f8f9fa;
        }
        
        .location-item.hidden {
            display: none;
        }
        
        .location-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            flex-shrink: 0;
            color: white;
        }
        
        .location-name {
            color: #495057;
            flex: 1;
            font-weight: 500;
        }
        
        .location-description {
            font-size: 9px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .edit-btn, .delete-btn {
            background: rgba(255, 110, 0, 0.1);
            color: var(--garbicz-orange);
            border: 1px solid rgba(255, 110, 0, 0.2);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 9px;
            cursor: pointer;
            margin-left: 4px;
            display: none;
            transition: all 0.2s ease;
            font-weight: 500;
            min-height: 32px;
        }
        
        .delete-btn {
            background: rgba(255, 0, 0, 0.1);
            color: var(--garbicz-red);
            border-color: rgba(255, 0, 0, 0.2);
        }
        
        .edit-mode .edit-btn,
        .edit-mode .delete-btn {
            display: block;
        }
        
        .edit-btn:hover, .edit-btn:active {
            background: var(--garbicz-orange);
            color: white;
            transform: translateY(-1px);
        }
        
        .delete-btn:hover, .delete-btn:active {
            background: var(--garbicz-red);
            color: white;
            transform: translateY(-1px);
        }
        
        .editing-mode {
            background: #fff3cd !important;
            border: 1px solid #ffeaa7 !important;
        }
        
        .edit-mode-title {
            color: #856404;
            font-weight: 600;
        }
        
        .map-overlay {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            padding: 12px;
            z-index: 1000;
            font-size: 10px;
            color: #6c757d;
            max-width: 180px;
        }
        
        .sync-indicator {
            font-size: 9px;
            color: #888;
            margin-top: 4px;
        }
        
        .sync-indicator.saving {
            color: var(--garbicz-orange);
        }
        
        .sync-indicator.saved {
            color: var(--garbicz-green);
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            max-width: 300px;
        }
        
        .leaflet-popup-content {
            margin: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        
        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 6px;
        }
        
        .popup-description {
            font-size: 13px;
            color: #495057;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .popup-details {
            font-size: 11px;
            color: #6c757d;
            line-height: 1.3;
            margin-bottom: 8px;
        }
        
        .popup-coords {
            font-size: 10px;
            color: #adb5bd;
            font-family: 'SF Mono', Consolas, monospace;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f1f3f4;
        }
        
        .popup-audio {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f1f3f4;
        }
        
        .popup-audio-btn {
            background: rgba(255, 0, 255, 0.1);
            color: var(--garbicz-purple);
            border: 1px solid rgba(255, 0, 255, 0.2);
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .popup-audio-btn:hover, .popup-audio-btn:active {
            background: var(--garbicz-pink);
            color: white;
            border-color: var(--garbicz-pink);
            transform: translateY(-1px);
        }
        
        .custom-icon {
            background: white;
            border: 1px solid #dee2e6;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            color: white;
            border-radius: 50%;
        }
        
        .needle-marker {
            background: transparent !important;
            border: none !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pulse-animation {
            animation: pulse 1s infinite;
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .map-container {
                height: 65vh;
                height: 65dvh;
            }
            
            .sidebar {
                height: 35vh;
                height: 35dvh;
            }
            
            .header h1 {
                font-size: 17px;
            }
            
            .header p {
                font-size: 13px;
            }
            
            .btn {
                font-size: 11px;
                padding: 10px 14px;
            }
        }
        
        @media (min-width: 769px) {
            .app {
                flex-direction: row;
            }
            
            .sidebar {
                width: 400px;
                order: 1;
                height: 100vh;
                height: 100dvh;
                border-top: none;
                border-right: 3px solid var(--garbicz-pink);
            }
            
            .sidebar.collapsed {
                transform: translateX(-360px);
                height: 100vh;
                height: 100dvh;
            }
            
            .sidebar-toggle {
                position: absolute;
                top: 50%;
                right: -40px;
                transform: translateY(-50%);
                background: white;
                color: var(--garbicz-purple);
                border: 1px solid #e9ecef;
                border-left: none;
                padding: 12px 8px;
                box-shadow: 2px 0 8px rgba(0,0,0,0.1);
                border-radius: 0 8px 8px 0;
                width: 40px;
                height: 60px;
            }
            
            .map-container {
                order: 2;
                height: 100vh;
                height: 100dvh;
                flex: 1;
            }
            
            .audio-player {
                max-width: 350px;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                right: auto;
            }
            
            .audio-player.active {
                transform: translateX(-50%) translateY(0);
            }
            
            .audio-player.collapsed {
                transform: translateX(-50%) translateY(40px);
            }
        }
        
        @media (max-width: 480px) {
            .audio-player {
                left: 10px;
                right: 10px;
                bottom: 10px;
            }
            
            .map-overlay {
                top: 10px;
                right: 10px;
                max-width: 160px;
                font-size: 9px;
                padding: 8px;
            }
            
            .location-item {
                min-height: 48px;
            }
            
            .btn {
                min-height: 40px;
            }
            
            .search-input {
                font-size: 16px;
            }
            
            .input-field {
                font-size: 16px;
            }
        }

        .btn, .audio-btn, .track-btn, .sidebar-toggle, .location-item, .edit-btn, .delete-btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .locations-list {
            overscroll-behavior: contain;
        }
    </style>
</head>
<body>
    <div class="garbicz-map-container">
        <div class="app" id="garbicz-app">
            <div class="map-container">
                <div id="map"></div>
                
                <div class="map-overlay">
                    <strong style="color: var(--garbicz-pink); text-shadow: 1px 1px 0 var(--garbicz-yellow);">GARBICZ FESTIVAL 2025</strong><br>
                    <span style="color: var(--garbicz-orange);">31.7. – 4.8.2025</span><br>
                    <span style="color: var(--garbicz-blue);">Interactive Map</span>
                    <div class="sync-indicator saved" id="sync-indicator">💾 Local storage</div>
                </div>
                
                <div class="audio-player" id="audio-player">
                    <div class="audio-header" onclick="toggleAudioPlayer()">
                        <div class="audio-title">
                            <span>🎵</span>
                            <span id="current-track-title">Garbicz Sounds</span>
                        </div>
                        <div class="audio-controls">
                            <button class="audio-btn" onclick="event.stopPropagation(); previousTrack()">⏮</button>
                            <button class="audio-btn" onclick="event.stopPropagation(); togglePlay()" id="play-btn">▶️</button>
                            <button class="audio-btn" onclick="event.stopPropagation(); nextTrack()">⏭</button>
                            <button class="audio-btn" onclick="event.stopPropagation(); closeAudioPlayer()">✕</button>
                        </div>
                    </div>
                    <div class="audio-content" id="audio-content">
                        <div class="track-selector" id="track-selector"></div>
                        <iframe class="soundcloud-widget" id="soundcloud-widget" src="" allow="autoplay"></iframe>
                        <div style="font-size: 9px; color: #888; text-align: center; margin-top: 8px;">
                            Curated Garbicz Festival sets from SoundCloud
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar" id="sidebar">
                <div class="sidebar-toggle" onclick="toggleSidebar()">
                    <span id="toggle-icon">▲</span>
                </div>
                
                <div class="header">
                    <h1>Garbicz Festival 2025</h1>
                    <p>Ultimate Interactive Map • Lake Wielicko</p>
                </div>
                
                <div class="controls">
                    <div class="festival-welcome">
                        <div class="welcome-title">Welcome to this Map!</div>
                        <div class="welcome-subtitle">Enter edit mode to add locations - saved locally</div>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Map Tools</div>
                        <div class="button-group">
                            <button class="btn" id="edit-mode-btn" onclick="toggleEditMode()">✏️ Edit</button>
                            <button class="btn" onclick="showAudioPlayer()">🎵 Listen</button>
                        </div>
                    </div>
                    
                    <div class="edit-controls" id="edit-controls" style="display: none;">
                        <div class="control-group">
                            <div class="control-label">Edit Tools</div>
                            <div class="button-group">
                                <button class="btn" id="needle-mode-btn" onclick="toggleNeedleMode()">📍 Pin</button>
                                <button class="btn" onclick="exportMap()">📤 Export</button>
                                <button class="btn" onclick="triggerImport()">📥 Import</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Map Views</div>
                        <div class="button-group">
                            <button class="btn active" id="street-btn" onclick="showStreet()">Street</button>
                            <button class="btn" id="sat-btn" onclick="showSatellite()">Satellite</button>
                        </div>
                    </div>
                </div>
                
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="Search stages, food, art..." onkeyup="searchLocations()">
                </div>
                
                <div class="add-location" id="add-location-form">
                    <div class="add-title" id="form-title">➕ Add Location</div>
                    <div class="input-group">
                        <label class="input-label">Name</label>
                        <input type="text" class="input-field" id="location-name" placeholder="e.g. Secret Stage">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Description</label>
                        <input type="text" class="input-field" id="location-description" placeholder="Brief description">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Details (optional)</label>
                        <input type="text" class="input-field" id="location-details" placeholder="Additional details">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Category</label>
                        <select class="input-field" id="location-category">
                            <option value="access">⚬ Access & Gates</option>
                            <option value="stages">◆ Stages & Floors</option>
                            <option value="services">i Services & Info</option>
                            <option value="food">▣ Food & Drinks</option>
                            <option value="camping">▲ Camping Areas</option>
                            <option value="art">◉ Art & Performance</option>
                            <option value="other">● Other</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Coordinates</label>
                        <div class="coord-inputs">
                            <input type="text" class="input-field" id="location-lat" placeholder="52.xxxxx">
                            <input type="text" class="input-field" id="location-lng" placeholder="15.xxxxx">
                        </div>
                    </div>
                    <button class="add-btn" id="form-submit-btn" onclick="addLocation()">Add to Map</button>
                    <button class="btn" id="cancel-edit-btn" onclick="cancelEdit()" style="display:none; margin-top:8px; width:100%;">Cancel Edit</button>
                </div>
                
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importMap(event)">
                
                <div class="locations-list" id="locations-list"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://w.soundcloud.com/player/api.js"></script>
    
    <script>
        // Garbicz Festival Sounds Database
        const garbiczTracks = {
            'waldfloor': {
                name: 'Waldfloor Vibes',
                url: 'https://soundcloud.com/peter-schumann/garbicz-festival-2024',
                artist: 'Peter Schumann',
                stage: 'Lichtung'
            },
            'wiese': {
                name: 'Wiese Closing',
                url: 'https://soundcloud.com/rss/garbicz-2024',
                artist: 'RSS Disco',
                stage: 'Wiese Floor'
            },
            'modular': {
                name: 'Modular Live',
                url: 'https://soundcloud.com/oh_why/live-at-garbicz',
                artist: 'O/Y',
                stage: 'BuK Corner'
            },
            'compilation': {
                name: 'Festival Mix',
                url: 'https://soundcloud.com/jeden-tag-ein-set/garbicz-2024',
                artist: 'Various Artists',
                stage: 'Multiple Stages'
            },
            'ambient': {
                name: 'Ambient Journey',
                url: 'https://soundcloud.com/nicostojan/nico-stojan-bachstelzen-garbicz',
                artist: 'Nico Stojan',
                stage: 'Loco Paradiso'
            }
        };
        
        // Global Variables
        let map;
        let currentLayer;
        let markers = [];
        let editMode = false;
        let needleMode = false;
        let needleMarker = null;
        let editingLocation = null;
        let collapsedCategories = new Set();
        let currentTrackIndex = 0;
        let soundcloudWidget = null;
        let audioPlayerCollapsed = false;
        
        // SoundCloud Widget Management
        let currentTrackKey = 'waldfloor';
        
        // Initialize map
        function initializeMap() {
            map = L.map('map', {
                zoomControl: false,
                scrollWheelZoom: true,
                touchZoom: true,
                doubleClickZoom: true,
                boxZoom: false,
                keyboard: true,
                dragging: true,
                tap: true,
                tapTolerance: 15
            }).setView([52.303, 15.001], 16);
            
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
            
            const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri, Maxar, GeoEye, Earthstar Geographics',
                maxZoom: 19
            });
            
            const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });
            
            currentLayer = streetMap;
            currentLayer.addTo(map);
            
            L.control.scale({
                position: 'bottomleft',
                imperial: false,
                metric: true
            }).addTo(map);
        }
        
        // Default locations data
        const defaultLocations = {
            access: [
                { name: 'Festival Entrance', lat: 52.306927328939516, lng: 14.999499430070339, icon: '⚬', color: '#ff0000', 
                  description: 'Main festival entrance through Garbicz village', audio: null },
                { name: 'Accreditation', lat: 52.30661986406152, lng: 14.99993184530935, icon: '●', color: '#ff6e00',
                  description: 'Check-in point for wristband activation', audio: null }
            ],
            stages: [
                { name: 'Lichtung', lat: 52.30519013153199, lng: 14.997405203689034, icon: '◐', color: '#00f000',
                  description: 'Sanctuary for human connection, workshops, performances, healing sounds.',
                  details: 'Workshops, Teebar, Sauna, Sober Space, Cacao & Adaptogenics, Brazilian Food',
                  audio: 'waldfloor' },
                { name: 'See Floor', lat: 52.30023773483686, lng: 15.003052948484568, icon: '◈', color: '#0096ff',
                  description: 'The village square of Garbicz Festival. Everything is allowed!',
                  details: 'Cooking shows, folkloric concerts, cabaret, drag performances, niche rave', audio: 'compilation' },
                { name: 'BuK Corner', lat: 52.29968063073753, lng: 15.004726846142004, icon: '♦', color: '#ff00ff',
                  description: 'Forest stage by the lake with deep house, minimal, and hypnotic grooves',
                  details: 'Nestled among birch and beech trees', audio: 'modular' },
                { name: 'Wiese Floor', lat: 52.30216061017868, lng: 15.000337285429515, icon: '◆', color: '#00f000',
                  description: 'House music floor with smooth, soulful beats and chill vibes',
                  details: 'Perfect place for warm, soulful house music', audio: 'wiese' },
                { name: 'Loco Paradiso', lat: 52.30184114434939, lng: 14.998969464384402, icon: '◉', color: '#7d19ff',
                  description: 'Ambientfloor - Multidimensional sanctuary of deep listening',
                  details: 'World music, organic-electronic soundscapes, sunrise rituals', audio: 'ambient' }
            ],
            food: [
                { name: 'Food Court Central', lat: 52.30291945144958, lng: 15.001182034150915, icon: '▤', color: '#ff6e00',
                  description: 'Central food area with diverse international cuisine',
                  details: 'Multiple vendors: Breakfast Club, NOMI, Schnitzel, Pizza, Burgers' },
                { name: 'Breakfast Club', lat: 52.3029, lng: 15.0012, icon: '☀', color: '#ffeb00',
                  description: 'Breakfast buffet with freshly baked bread, cheese, spreads',
                  details: 'Open 08:00–13:00, tasty detention vibes' }
            ],
            services: [
                { name: 'Festival Info', lat: 52.30268891943137, lng: 15.00091328786337, icon: 'i', color: '#0019ff',
                  description: 'Information, lost & found, top-up station, phone charging',
                  details: 'Located near Wiese, helps with cashless payment system' },
                { name: 'Medical Team', lat: 52.302887633796416, lng: 15.000352599661282, icon: '+', color: '#ff0000',
                  description: 'German, English and Polish speaking medics always present',
                  details: 'Located next to food court, here to help and care' }
            ],
            camping: [
                { name: 'Silent Camping', lat: 52.30782269506013, lng: 14.997747885233208, icon: '🤫', color: '#00f000',
                  description: 'Quiet camping area for rest and tranquility' },
                { name: 'Main Camping', lat: 52.30352192280878, lng: 15.002847519852684, icon: '⛺', color: '#00ffff',
                  description: 'Main guest camping area within walking distance' }
            ],
            art: [
                { name: 'Nerdwald Art Zone', lat: 52.301, lng: 15.002, icon: '🎨', color: '#ff00ff',
                  description: 'Art installations area with experimental exhibits',
                  details: 'Various installations and interactive art pieces' }
            ]
        };
        
        let locations = {};
        
        // Local Storage Functions (simple browser storage)
        function saveToLocalStorage() {
            try {
                const data = {
                    locations: locations,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0'
                };
                localStorage.setItem('garbicz-map-data', JSON.stringify(data));
                updateSyncIndicator('saved', '💾 Saved locally');
                
                setTimeout(() => {
                    updateSyncIndicator('', '💾 Local storage');
                }, 2000);
                
                return true;
            } catch (error) {
                console.error('Save error:', error);
                updateSyncIndicator('error', '❌ Save failed');
                return false;
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('garbicz-map-data');
                if (saved) {
                    const data = JSON.parse(saved);
                    locations = data.locations || defaultLocations;
                    updateSyncIndicator('saved', '💾 Loaded from storage');
                } else {
                    locations = { ...defaultLocations };
                    saveToLocalStorage();
                }
                
                setTimeout(() => {
                    updateSyncIndicator('', '💾 Local storage');
                }, 2000);
                
            } catch (error) {
                console.error('Load error:', error);
                locations = { ...defaultLocations };
                updateSyncIndicator('error', '❌ Using defaults');
            }
            
            addLocationsToMap();
            updateLocationsList();
        }
        
        function updateSyncIndicator(status, message) {
            const indicator = document.getElementById('sync-indicator');
            indicator.className = `sync-indicator ${status}`;
            indicator.textContent = message;
        }
        
        // Audio Player Functions
        function initializeAudioPlayer() {
            const trackSelector = document.getElementById('track-selector');
            trackSelector.innerHTML = '';
            
            Object.keys(garbiczTracks).forEach((key, index) => {
                const track = garbiczTracks[key];
                const btn = document.createElement('button');
                btn.className = 'track-btn' + (index === 0 ? ' active' : '');
                btn.textContent = track.name;
                btn.onclick = () => loadTrack(key);
                trackSelector.appendChild(btn);
            });
            
            loadTrack(currentTrackKey);
        }
        
        function loadTrack(trackKey) {
            const track = garbiczTracks[trackKey];
            if (!track) return;
            
            currentTrackKey = trackKey;
            document.getElementById('current-track-title').textContent = track.name;
            
            document.querySelectorAll('.track-btn').forEach((btn, index) => {
                btn.classList.toggle('active', Object.keys(garbiczTracks)[index] === trackKey);
            });
            
            const widget = document.getElementById('soundcloud-widget');
            const embedUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(track.url)}&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&visual=true&color=ff00ff`;
            widget.src = embedUrl;
            
            setTimeout(() => {
                soundcloudWidget = SC.Widget('soundcloud-widget');
            }, 1000);
        }
        
        function showAudioPlayer() {
            const player = document.getElementById('audio-player');
            player.classList.add('active');
            if (!soundcloudWidget) {
                initializeAudioPlayer();
            }
        }
        
        function closeAudioPlayer() {
            const player = document.getElementById('audio-player');
            player.classList.remove('active');
            if (soundcloudWidget) {
                soundcloudWidget.pause();
            }
        }
        
        function toggleAudioPlayer() {
            const content = document.getElementById('audio-content');
            const player = document.getElementById('audio-player');
            
            audioPlayerCollapsed = !audioPlayerCollapsed;
            content.classList.toggle('collapsed', audioPlayerCollapsed);
            player.classList.toggle('collapsed', audioPlayerCollapsed);
        }
        
        function togglePlay() {
            if (soundcloudWidget) {
                soundcloudWidget.toggle();
            }
        }
        
        function previousTrack() {
            const keys = Object.keys(garbiczTracks);
            const currentIndex = keys.indexOf(currentTrackKey);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : keys.length - 1;
            loadTrack(keys[prevIndex]);
        }
        
        function nextTrack() {
            const keys = Object.keys(garbiczTracks);
            const currentIndex = keys.indexOf(currentTrackKey);
            const nextIndex = currentIndex < keys.length - 1 ? currentIndex + 1 : 0;
            loadTrack(keys[nextIndex]);
        }
        
        // Icon creation function
        function createCustomIcon(symbol, bgColor = '#ffffff') {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div class="custom-icon" style="background: ${bgColor}; border-color: ${bgColor};">${symbol}</div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -12]
            });
        }
        
        // Add all locations to map
        function addLocationsToMap() {
            markers.forEach(markerObj => {
                if (markerObj.marker) {
                    map.removeLayer(markerObj.marker);
                }
            });
            markers = [];
            
            Object.keys(locations).forEach(category => {
                locations[category].forEach(location => {
                    const marker = L.marker([location.lat, location.lng], {
                        icon: createCustomIcon(location.icon, location.color)
                    }).addTo(map);
                    
                    let popupContent = `
                        <div>
                            <div class="popup-title">${location.icon} ${location.name}</div>
                            <div class="popup-description">${location.description}</div>
                            ${location.details ? `<div class="popup-details">${location.details}</div>` : ''}
                    `;
                    
                    if (location.audio && garbiczTracks[location.audio]) {
                        const track = garbiczTracks[location.audio];
                        popupContent += `
                            <div class="popup-audio">
                                <button class="popup-audio-btn" onclick="loadTrack('${location.audio}'); showAudioPlayer();">
                                    🎵 Play ${track.artist}
                                </button>
                            </div>
                        `;
                    }
                    
                    popupContent += `
                            <div class="popup-coords">${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}</div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    markers.push({ marker, location, category });
                });
            });
        }
        
        // Edit Mode Functions
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('edit-mode-btn');
            const form = document.getElementById('add-location-form');
            const controls = document.getElementById('edit-controls');
            const app = document.getElementById('garbicz-app');
            
            if (editMode) {
                btn.classList.add('active');
                btn.textContent = '🔒 Lock';
                form.classList.add('show');
                controls.style.display = 'block';
                app.classList.add('edit-mode');
            } else {
                btn.classList.remove('active');
                btn.textContent = '✏️ Edit';
                form.classList.remove('show');
                controls.style.display = 'none';
                app.classList.remove('edit-mode');
                clearMapClick();
                if (editingLocation) cancelEdit();
            }
            
            updateLocationsList();
        }
        
        // Needle Mode Functions
        function toggleNeedleMode() {
            if (!editMode) {
                alert('Please enable Edit Mode first');
                return;
            }
            
            needleMode = !needleMode;
            const btn = document.getElementById('needle-mode-btn');
            
            if (needleMode) {
                btn.classList.add('active');
                btn.textContent = '📍 Active';
                map.getContainer().style.cursor = 'crosshair';
                map.on('click', onMapClick);
            } else {
                clearMapClick();
            }
        }
        
        function clearMapClick() {
            needleMode = false;
            const btn = document.getElementById('needle-mode-btn');
            if (btn) {
                btn.classList.remove('active');
                btn.textContent = '📍 Pin';
            }
            map.getContainer().style.cursor = '';
            map.off('click', onMapClick);
            
            if (needleMarker) {
                map.removeLayer(needleMarker);
                needleMarker = null;
            }
        }
        
        function onMapClick(e) {
            if (!needleMode) return;
            
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            if (needleMarker) {
                map.removeLayer(needleMarker);
            }
            
            const needleIcon = L.divIcon({
                className: 'needle-marker',
                html: '<div style="width: 20px; height: 20px; background: var(--garbicz-red); border: 3px solid var(--garbicz-yellow); border-radius: 50%; box-shadow: 0 3px 10px rgba(255,0,0,0.5);" class="pulse-animation"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            needleMarker = L.marker([lat, lng], {icon: needleIcon}).addTo(map);
            
            document.getElementById('location-lat').value = lat.toFixed(6);
            document.getElementById('location-lng').value = lng.toFixed(6);
            
            const popup = L.popup()
                .setLatLng([lat, lng])
                .setContent(`
                    <div style="text-align: center; min-width: 180px;">
                        <div style="font-weight: 600; color: var(--garbicz-pink); margin-bottom: 8px;">📍 Pin Placed</div>
                        <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                            <strong>Lat:</strong> ${lat.toFixed(6)}<br>
                            <strong>Lng:</strong> ${lng.toFixed(6)}
                        </div>
                        <div style="font-size: 10px; color: #888;">
                            Coordinates ready for ${editingLocation ? 'editing' : 'adding'} location
                        </div>
                    </div>
                `)
                .openOn(map);
            
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    document.getElementById('add-location-form').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        }
        
        // Location Management Functions
        function editLocation(category, index) {
            if (!editMode) {
                alert('Please enable Edit Mode first');
                return;
            }
            
            const location = locations[category][index];
            editingLocation = { category, index, location };
            
            document.getElementById('location-name').value = location.name || '';
            document.getElementById('location-description').value = location.description || '';
            document.getElementById('location-details').value = location.details || '';
            document.getElementById('location-category').value = category;
            document.getElementById('location-lat').value = location.lat || '';
            document.getElementById('location-lng').value = location.lng || '';
            
            document.getElementById('form-title').textContent = '✏️ Edit Location';
            document.getElementById('form-title').className = 'add-title edit-mode-title';
            document.getElementById('form-submit-btn').textContent = 'Update Location';
            document.getElementById('cancel-edit-btn').style.display = 'block';
            document.querySelector('.add-location').classList.add('editing-mode');
            
            document.getElementById('add-location-form').classList.add('show');
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    document.getElementById('add-location-form').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        }
        
        function deleteLocation(category, index) {
            if (!editMode) {
                alert('Please enable Edit Mode first');
                return;
            }
            
            const location = locations[category][index];
            if (confirm(`Delete "${location.name}"?`)) {
                const markerToRemove = markers.find(m => m.location === location);
                if (markerToRemove) {
                    map.removeLayer(markerToRemove.marker);
                    markers.splice(markers.indexOf(markerToRemove), 1);
                }
                
                locations[category].splice(index, 1);
                
                updateLocationsList();
                saveToLocalStorage();
            }
        }
        
        function cancelEdit() {
            editingLocation = null;
            clearForm();
            clearMapClick();
            
            document.getElementById('form-title').textContent = '➕ Add Location';
            document.getElementById('form-title').className = 'add-title';
            document.getElementById('form-submit-btn').textContent = 'Add to Map';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.querySelector('.add-location').classList.remove('editing-mode');
        }
        
        function addLocation() {
            if (!editMode) {
                alert('Please enable Edit Mode first');
                return;
            }
            
            if (editingLocation) {
                updateLocation();
                return;
            }
            
            const name = document.getElementById('location-name').value.trim();
            const description = document.getElementById('location-description').value.trim();
            const details = document.getElementById('location-details').value.trim();
            const category = document.getElementById('location-category').value;
            const lat = parseFloat(document.getElementById('location-lat').value);
            const lng = parseFloat(document.getElementById('location-lng').value);
            
            if (!name || isNaN(lat) || isNaN(lng)) {
                alert('Please fill in name and valid coordinates');
                return;
            }
            
            const categoryConfig = {
                access: { icon: '⚬', color: '#ff0000' },
                stages: { icon: '◆', color: '#ff00ff' },
                food: { icon: '▤', color: '#ff6e00' },
                services: { icon: 'i', color: '#0019ff' },
                camping: { icon: '▲', color: '#00ffff' },
                art: { icon: '◉', color: '#ffeb00' },
                other: { icon: '●', color: '#7d7d7d' }
            };
            
            const config = categoryConfig[category];
            const newLocation = {
                name,
                lat,
                lng,
                icon: config.icon,
                color: config.color,
                description: description || 'User added location',
                details: details || '',
                audio: null
            };
            
            if (!locations[category]) locations[category] = [];
            locations[category].push(newLocation);
            
            const marker = L.marker([lat, lng], {
                icon: createCustomIcon(newLocation.icon, newLocation.color)
            }).addTo(map);
            
            const popupContent = `
                <div>
                    <div class="popup-title">${newLocation.icon} ${name}</div>
                    <div class="popup-description">${newLocation.description}</div>
                    ${newLocation.details ? `<div class="popup-details">${newLocation.details}</div>` : ''}
                    <div class="popup-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            markers.push({ marker, location: newLocation, category });
            
            updateLocationsList();
            saveToLocalStorage();
            clearForm();
            clearMapClick();
            
            map.setView([lat, lng], 17);
            marker.openPopup();
        }
        
        function updateLocation() {
            if (!editingLocation) return;
            
            const name = document.getElementById('location-name').value.trim();
            const description = document.getElementById('location-description').value.trim();
            const details = document.getElementById('location-details').value.trim();
            const category = document.getElementById('location-category').value;
            const lat = parseFloat(document.getElementById('location-lat').value);
            const lng = parseFloat(document.getElementById('location-lng').value);
            
            if (!name || isNaN(lat) || isNaN(lng)) {
                alert('Please fill in name and valid coordinates');
                return;
            }
            
            const { category: oldCategory, index, location } = editingLocation;
            
            const markerToRemove = markers.find(m => m.location === location);
            if (markerToRemove) {
                map.removeLayer(markerToRemove.marker);
                markers.splice(markers.indexOf(markerToRemove), 1);
            }
            
            const updatedLocation = {
                ...location,
                name,
                description,
                details,
                lat,
                lng
            };
            
            if (category !== oldCategory) {
                locations[oldCategory].splice(index, 1);
                if (!locations[category]) locations[category] = [];
                locations[category].push(updatedLocation);
            } else {
                locations[oldCategory][index] = updatedLocation;
            }
            
            const marker = L.marker([lat, lng], {
                icon: createCustomIcon(updatedLocation.icon, updatedLocation.color)
            }).addTo(map);
            
            let popupContent = `
                <div>
                    <div class="popup-title">${updatedLocation.icon} ${name}</div>
                    <div class="popup-description">${description}</div>
                    ${details ? `<div class="popup-details">${details}</div>` : ''}
            `;
            
            if (updatedLocation.audio && garbiczTracks[updatedLocation.audio]) {
                const track = garbiczTracks[updatedLocation.audio];
                popupContent += `
                    <div class="popup-audio">
                        <button class="popup-audio-btn" onclick="loadTrack('${updatedLocation.audio}'); showAudioPlayer();">
                            🎵 Play ${track.artist}
                        </button>
                    </div>
                `;
            }
            
            popupContent += `
                    <div class="popup-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            markers.push({ marker, location: updatedLocation, category });
            
            updateLocationsList();
            saveToLocalStorage();
            cancelEdit();
            
            map.setView([lat, lng], 17);
            marker.openPopup();
        }
        
        function clearForm() {
            document.getElementById('location-name').value = '';
            document.getElementById('location-description').value = '';
            document.getElementById('location-details').value = '';
            document.getElementById('location-lat').value = '';
            document.getElementById('location-lng').value = '';
        }
        
        // Export/Import Functions
        function exportMap() {
            const exportData = {
                version: '1.0',
                created: new Date().toISOString(),
                festival: 'Garbicz Festival 2025',
                locations: locations
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `garbicz-map-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('🎉 Map exported successfully!');
        }
        
        function triggerImport() {
            document.getElementById('import-file').click();
        }
        
        function importMap(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.json')) {
                alert('Please select a JSON file');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.locations || typeof importData.locations !== 'object') {
                        alert('Invalid file format.');
                        return;
                    }
                    
                    const confirmMessage = `Import map data${importData.created ? ` from ${importData.created.split('T')[0]}` : ''}?\n\nThis will add new locations to your current map.`;
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    let importCount = 0;
                    
                    Object.keys(importData.locations).forEach(category => {
                        if (!Array.isArray(importData.locations[category])) return;
                        
                        if (!locations[category]) locations[category] = [];
                        
                        importData.locations[category].forEach(location => {
                            if (!location.name || typeof location.lat !== 'number' || typeof location.lng !== 'number') {
                                return;
                            }
                            
                            const exists = locations[category].some(loc => 
                                loc.name === location.name && 
                                Math.abs(loc.lat - location.lat) < 0.00001 && 
                                Math.abs(loc.lng - location.lng) < 0.00001
                            );
                            
                            if (!exists) {
                                locations[category].push({
                                    name: location.name,
                                    lat: location.lat,
                                    lng: location.lng,
                                    icon: location.icon || '●',
                                    color: location.color || '#7d7d7d',
                                    description: location.description || '',
                                    details: location.details || '',
                                    audio: location.audio || null
                                });
                                importCount++;
                            }
                        });
                    });
                    
                    addLocationsToMap();
                    updateLocationsList();
                    saveToLocalStorage();
                    
                    alert(`🎉 Successfully imported ${importCount} new locations!`);
                    
                } catch (err) {
                    alert('Error reading file.');
                    console.error('Import error:', err);
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // Search functionality
        function searchLocations() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const items = document.querySelectorAll('.location-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(query)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }
        
        // Category management
        function toggleCategory(category) {
            if (collapsedCategories.has(category)) {
                collapsedCategories.delete(category);
            } else {
                collapsedCategories.add(category);
            }
            updateLocationsList();
        }
        
        // Update locations list
        function updateLocationsList() {
            const listContainer = document.getElementById('locations-list');
            listContainer.innerHTML = '';
            
            const categoryTitles = {
                access: '⚬ Access & Gates',
                stages: '◆ Stages & Floors',
                food: '▤ Food & Drinks',
                services: 'i Services & Info',
                camping: '▲ Camping Areas',
                art: '◉ Art & Performance',
                other: '● Other'
            };
            
            Object.keys(locations).forEach(category => {
                if (locations[category].length === 0) return;
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'location-category';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'category-title';
                titleDiv.onclick = () => toggleCategory(category);
                
                const isCollapsed = collapsedCategories.has(category);
                titleDiv.innerHTML = `
                    ${categoryTitles[category] || category}
                    <span class="category-toggle">${isCollapsed ? '▼' : '▲'}</span>
                `;
                categoryDiv.appendChild(titleDiv);
                
                const itemsDiv = document.createElement('div');
                itemsDiv.className = `category-items ${isCollapsed ? 'collapsed' : ''}`;
                itemsDiv.style.maxHeight = isCollapsed ? '0' : '500px';
                
                locations[category].forEach((location, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'location-item';
                    itemDiv.onclick = (e) => {
                        if (!e.target.classList.contains('edit-btn') && !e.target.classList.contains('delete-btn')) {
                            map.setView([location.lat, location.lng], 18);
                            const marker = markers.find(m => m.location === location);
                            if (marker) marker.marker.openPopup();
                        }
                    };
                    
                    let audioIndicator = '';
                    if (location.audio && garbiczTracks[location.audio]) {
                        audioIndicator = ' 🎵';
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="location-icon" style="background: ${location.color}; color: white;">
                            ${location.icon}
                        </div>
                        <div style="flex: 1;">
                            <div class="location-name">${location.name}${audioIndicator}</div>
                            ${location.description ? `<div class="location-description">${location.description.substring(0, 50)}...</div>` : ''}
                        </div>
                        <button class="edit-btn" onclick="editLocation('${category}', ${index}); event.stopPropagation();">✏️</button>
                        <button class="delete-btn" onclick="deleteLocation('${category}', ${index}); event.stopPropagation();">🗑️</button>
                    `;
                    
                    itemsDiv.appendChild(itemDiv);
                });
                
                categoryDiv.appendChild(itemsDiv);
                listContainer.appendChild(categoryDiv);
            });
        }
        
        // Map control functions
        function showSatellite() {
            const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri, Maxar, GeoEye, Earthstar Geographics',
                maxZoom: 19
            });
            
            map.removeLayer(currentLayer);
            currentLayer = satelliteMap;
            currentLayer.addTo(map);
            updateActiveButton('sat-btn');
        }
        
        function showStreet() {
            const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });
            
            map.removeLayer(currentLayer);
            currentLayer = streetMap;
            currentLayer.addTo(map);
            updateActiveButton('street-btn');
        }
        
        function updateActiveButton(activeId) {
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            if (document.getElementById(activeId)) {
                document.getElementById(activeId).classList.add('active');
            }
        }
        
        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('toggle-icon');
            
            sidebar.classList.toggle('collapsed');
            
            if (window.innerWidth > 768) {
                toggleIcon.textContent = sidebar.classList.contains('collapsed') ? '›' : '‹';
            } else {
                toggleIcon.textContent = sidebar.classList.contains('collapsed') ? '▼' : '▲';
            }
        }
        
        // Initialize everything
        function initializeApp() {
            initializeMap();
            loadFromLocalStorage();
            
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', handleResize);
            
            console.log('🎉 Garbicz Festival Map 2025 initialized!');
        }
        
        function handleResize() {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                    
                    const sidebar = document.getElementById('sidebar');
                    const toggleIcon = document.getElementById('toggle-icon');
                    
                    if (toggleIcon) {
                        if (window.innerWidth > 768) {
                            toggleIcon.textContent = sidebar.classList.contains('collapsed') ? '›' : '‹';
                        } else {
                            toggleIcon.textContent = sidebar.classList.contains('collapsed') ? '▼' : '▲';
                        }
                    }
                }, 100);
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Expose functions globally
        if (typeof window !== 'undefined') {
            window.GarbiczMap = {
                init: initializeApp,
                showAudioPlayer: showAudioPlayer,
                loadTrack: loadTrack,
                toggleEditMode: toggleEditMode,
                exportMap: exportMap
            };
        }
    </script>
</body>
</html>